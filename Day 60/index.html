<html>
<head>
  <title>Sundance 2012</title>
  <link rel="stylesheet" href="style.css">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.11/d3.min.js"></script>
  <script src="/js/gAnalytics.js"></script>

</head>
<body>
  <div id="title"><h3>Sundance 2012</h3></div>
  <button class="btn btn-default btn-xs revenue-func">Box office revenue in $</button>
  <button class="btn btn-default btn-xs price-func">Acquisition price</button>
  <button class="btn btn-default btn-xs opening-func">Opening # of theaters</button>
  <button class="btn btn-default btn-xs peak-func">Peak # of movie theaters</button>
  <button class="btn btn-default btn-xs days-func">Days played in movie theaters</button>
  <button class="btn btn-default btn-xs countries-func"># of Countries played in</button>
  <button class="btn btn-default btn-xs vod-func"># of VOD platforms</button>

<script type="text/javascript">
    // svg attrs
  var w = $(window).width() - 100,
      h = $(window).height() - 100,
      padding = 200;

   svg = d3.select("body")
      .append("svg")
      .attr("width", w)
      .attr("height", h)
      .attr("class", "chart")

  d3.selectAll(".opening-func")
    .on("click", function () {
      redraw(opening, "Opening")
    })

  d3.selectAll(".revenue-func")
    .on("click", function () {
      redraw(revenue, "Revenue")
    })

  d3.selectAll(".price-func")
    .on("click", function () {
      redraw(price, "Price")
    })

  d3.selectAll(".peak-func")
    .on("click", function () {
      redraw(peak, "Peak")
    })

  d3.selectAll(".days-func")
    .on("click", function () {
      redraw(days, "Days")
    })

  d3.selectAll(".countries-func")
    .on("click", function () {
      redraw(countries, "Countries")
    })
  d3.selectAll(".vod-func")
    .on("click", function () {
      redraw(vod, "VOD")
    })


  var price = function (d) {
    return +d.values[0].Price // 
  }
  var revenue = function (d) { //
    return +d.values[0].Revenue 
  } 
  var opening = function (d) { // 
    return +d.values[0].Opening
  }   
  var peak = function (d) { // 
    return +d.values[0].Peak
  }
  var days = function (d) {
    return +d.values[0].Days
  }
  var countries = function (d) {
    return +d.values[0].Countries
  }
  var vod = function (d) {
    return +d.values[0].VOD
  }
 


// ~~~~~~~~~~ INITIALIZE ~~~~~~~~~
    d3.csv("sundance2.csv", function (csv) {
      var data = d3.nest()
        .entries(csv);

       dataByKey = d3.nest()
        .key(function (d) {
          return d.Title
        })
        .entries(csv)

    var sorted = dataByKey.sort(function (a,b) {
      return b.values[0].Revenue - a.values[0].Revenue
    })

  // scales
  var y = d3.scale.ordinal()
     .domain(sorted.map(function (d) {
        return d.key;
     }))
     .rangeRoundBands([h, 0], .1);

  var x = d3.scale.linear()
     .domain([0, d3.max(sorted, revenue)])
     .range([0, w - 250]);

  // axes
  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom")

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")

  // chart
   chart = d3.select(".chart")
    .attr("width", w )
    .attr("height", h + 100)
    .append("g")

  chart.selectAll(".bar")
     .data(sorted)
     .enter()
     .append("rect")
     .attr("class", "bar")
     .attr("x", padding)
     .attr("y", function (d) {
        return y(d.key);
     })
     // NOTE FOR SELF: REMEMBER: HEIGHT AND WIDTH, NOT H & W
     .attr("width", function (d) {
        return x(revenue(d));
     })
     .attr("height", y.rangeBand())
     
  // appending axes to chart
  chart.append("g")
       .attr("class", "x axis")
       .attr("transform", "translate("+padding+"," + h + ")")
       .call(xAxis)

  chart.append("g")
       .attr("class", "y axis")
       .attr("transform", "translate("+padding+ "," + 0 + ")")
       .call(yAxis)

    })
// ~~~~~~~~~~ INITIALIZE ~~~~~~~~~




 function redraw(widthVar, stringVal) {
  
  // sorting new information
  var sorted = dataByKey.sort(function (a,b) {
      return b["values"][0][stringVal] - a["values"][0][stringVal]
    })

  // new scales
  var y = d3.scale.ordinal()
     .domain(sorted.map(function (d) {
        return d.key;
     }))
     .rangeRoundBands([h, 0], .1);

  var x = d3.scale.linear()
     .domain([0, d3.max(sorted, widthVar)])
     .range([0, w - 250]);

  // new axes
  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom")

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")

  // update
  var rect = chart.selectAll("rect")
     .data(sorted)


    rect.transition()
      .duration(1000) 
      .attr("class", "bar")
      .attr("x", padding)

      .attr("y", function (d) {
         return y(d.key);
      })
     // NOTE FOR SELF: REMEMBER: HEIGHT AND WIDTH, NOT H & W
      .attr("width", function (d) {
         return x(widthVar(d));
      })
      .attr("height", y.rangeBand())

    // added transitions to the axes too!
    svg.select(".x.axis").transition()
       .call(xAxis)

    svg.select(".y.axis").transition()
       .call(yAxis)
}
 

</script>
</body>
</html>